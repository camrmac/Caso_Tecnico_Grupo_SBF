-- =====================================================
-- üèóÔ∏è ARQUITETURA GERAL
-- =====================================================

/*
Este banco de dados segue a arquitetura Medallion com duas camadas:

1. TRUSTED (Bronze/Raw): Dados brutos normalizados e validados
   - Estrutura de dados source-of-truth
   - Integridade referencial garantida
   - Dados hist√≥ricos completos
   - Conformidade LGPD (dados PII separados)

2. REFINED (Silver/Curated): Dados agregados para an√°lise
   - M√©tricas de neg√≥cio pr√©-calculadas
   - Performance otimizada para consumo
   - Tabelas desnormalizadas
   - Pronto para BI e dashboards

FLUXO DE DADOS:
CSV Files ‚Üí Trusted (valida√ß√£o) ‚Üí Refined (agrega√ß√£o) ‚Üí Consumo (BI)
*/

-- =====================================================
-- SCHEMA: trusted
-- =====================================================

-- -----------------------------------------------------
-- Tabela: trusted.marca
-- -----------------------------------------------------
-- Descri√ß√£o: Cat√°logo de marcas de produtos
-- Granularidade: Uma linha por marca
-- Relacionamentos: 
--   - marca ‚Üê produto (1:N)
--   - marca ‚Üê meta (1:N)
-- -----------------------------------------------------
-- Campos:
--   id              : Identificador √∫nico da marca (PK)
--   nome            : Nome da marca (ex: "Nike", "Adidas")
--   criado_em       : Timestamp de cria√ß√£o do registro
--   atualizado_em   : Timestamp da √∫ltima atualiza√ß√£o
-- -----------------------------------------------------
-- Exemplo de registro:
-- | id | nome    | criado_em           | atualizado_em       |
-- |----|---------|---------------------|---------------------|
-- | 1  | Nike    | 2024-01-01 10:00:00 | 2024-01-01 10:00:00 |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.produto
-- -----------------------------------------------------
-- Descri√ß√£o: Cat√°logo completo de produtos
-- Granularidade: Uma linha por produto
-- Relacionamentos:
--   - produto ‚Üí marca (N:1)
--   - produto ‚Üê pedido_item (1:N)
-- -----------------------------------------------------
-- Campos:
--   id              : Identificador √∫nico do produto (PK)
--   id_marca        : FK para marca (qual marca fabrica este produto)
--   nome            : Nome do produto
--   descricao       : Descri√ß√£o detalhada do produto
--   categoria       : Categoria do produto (ex: "T√™nis", "Camiseta")
--   criado_em       : Timestamp de cria√ß√£o do registro
--   atualizado_em   : Timestamp da √∫ltima atualiza√ß√£o
-- -----------------------------------------------------
-- √çndices:
--   - idx_produto_marca : Performance em JOINs com marca
-- -----------------------------------------------------
-- Exemplo de registro:
-- | id | id_marca | nome              | categoria | criado_em           |
-- |----|----------|-------------------|-----------|---------------------|
-- | 10 | 1        | T√™nis Nike Air Max| T√™nis     | 2024-01-01 10:00:00 |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.data (Dimens√£o Temporal)
-- -----------------------------------------------------
-- Descri√ß√£o: Dimens√£o de datas para an√°lises temporais
-- Granularidade: Uma linha por dia
-- Relacionamentos:
--   - data ‚Üê pedido (1:N)
-- Prop√≥sito: Facilitar agrega√ß√µes por per√≠odo (ano, m√™s, trimestre)
-- -----------------------------------------------------
-- Campos:
--   data            : Data (PK)
--   ano             : Ano extra√≠do da data (ex: 2024)
--   mes             : M√™s extra√≠do da data (1-12)
--   dia             : Dia extra√≠do da data (1-31)
--   descricao       : Descri√ß√£o leg√≠vel (ex: "Segunda-feira, 01 Janeiro 2024")
-- -----------------------------------------------------
-- Exemplo de registro:
-- | data       | ano  | mes | dia | descricao                       |
-- |------------|------|-----|-----|---------------------------------|
-- | 2024-01-01 | 2024 | 1   | 1   | Segunda-feira, 01 Janeiro 2024  |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.cliente_pii
-- -----------------------------------------------------
-- Descri√ß√£o: Dados pessoais identific√°veis (PII) dos clientes
-- ‚ö†Ô∏è LGPD: Acesso restrito e auditado
-- Granularidade: Uma linha por cliente
-- Relacionamentos:
--   - cliente_pii ‚Üí cliente_pseudo (1:1)
-- -----------------------------------------------------
-- Campos:
--   cliente_id      : Identificador √∫nico do cliente (PK)
--   nome_full       : Nome completo do cliente
--   cpf             : CPF do cliente (11 d√≠gitos)
--   email           : Email do cliente
--   telefone        : Telefone do cliente
--   endereco        : Endere√ßo completo (JSONB)
--   criado_em       : Timestamp de cria√ß√£o do registro
-- -----------------------------------------------------
-- Seguran√ßa:
--   - Acesso restrito via permiss√µes do banco
--   - Dados n√£o utilizados em an√°lises
--   - Mantido apenas para compliance e auditoria
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.cliente_pseudo
-- -----------------------------------------------------
-- Descri√ß√£o: Dados pseudonimizados de clientes para an√°lises
-- Prop√≥sito: Permitir an√°lises sem expor PII (LGPD compliant)
-- Granularidade: Uma linha por cliente
-- Relacionamentos:
--   - cliente_pseudo ‚Üí cliente_pii (1:1)
--   - cliente_pseudo ‚Üê pedido (1:N)
-- -----------------------------------------------------
-- Campos:
--   cliente_id        : FK para cliente_pii
--   cliente_id_hash   : Hash SHA-256 do cliente_id (usado em an√°lises)
-- -----------------------------------------------------
-- Exemplo de uso:
--   Todas as an√°lises devem usar cliente_id_hash ao inv√©s de 
--   dados identific√°veis do cliente_pii
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.pedido
-- -----------------------------------------------------
-- Descri√ß√£o: Pedidos realizados pelos clientes
-- Granularidade: Uma linha por pedido
-- Relacionamentos:
--   - pedido ‚Üí data (N:1)
--   - pedido ‚Üí cliente_pseudo (N:1)
--   - pedido ‚Üê pedido_item (1:N)
-- -----------------------------------------------------
-- Campos:
--   id                : Identificador √∫nico do pedido (PK)
--   data              : Data do pedido (FK para dimens√£o data)
--   status            : Status do pedido (FINALIZADO, CANCELADO)
--   sgl_uf_entrega    : Sigla UF de entrega (ex: SP, RJ, MG)
--   vlr_total         : Valor total do pedido (inclui todos os itens)
--   cliente_id_hash   : Hash do cliente (FK para cliente_pseudo)
--   criado_em         : Timestamp de cria√ß√£o do registro
--   atualizado_em     : Timestamp da √∫ltima atualiza√ß√£o
-- -----------------------------------------------------
-- √çndices:
--   - idx_pedido_data_uf : Performance em an√°lises por per√≠odo e regi√£o
-- -----------------------------------------------------
-- Constraints:
--   - chk_pedido_sgl_uf_entrega : UF deve ter exatamente 2 letras mai√∫sculas
-- -----------------------------------------------------
-- Regras de Neg√≥cio:
--   1. vlr_total = soma dos itens n√£o cancelados (flg_cancelado = 'N')
--   2. Pedidos cancelados t√™m status = 'CANCELADO'
--   3. Pedidos sem UF s√£o entregas n√£o f√≠sicas ou em processamento
-- -----------------------------------------------------
-- Exemplo de registro:
-- | id  | data       | status     | sgl_uf_entrega | vlr_total |
-- |-----|------------|------------|----------------|-----------|
-- | 100 | 2024-01-15 | FINALIZADO | SP             | 299.90    |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.pedido_item
-- -----------------------------------------------------
-- Descri√ß√£o: Itens individuais de cada pedido
-- Granularidade: Uma linha por item de pedido
-- Relacionamentos:
--   - pedido_item ‚Üí pedido (N:1)
--   - pedido_item ‚Üí produto (N:1)
-- -----------------------------------------------------
-- Campos:
--   id              : Identificador √∫nico do item (PK)
--   id_pedido       : FK para pedido (qual pedido cont√©m este item)
--   id_produto      : FK para produto (qual produto foi vendido)
--   flg_cancelado   : Item cancelado? (S/N)
--   qtd_produto     : Quantidade vendida deste produto
--   vlr_unitario    : Valor unit√°rio do produto neste pedido
-- -----------------------------------------------------
-- √çndices:
--   - idx_pedido_item_produto : Performance em an√°lises de produtos
-- -----------------------------------------------------
-- Regras de Neg√≥cio:
--   1. Item cancelado (flg_cancelado = 'S') n√£o conta no vlr_total do pedido
--   2. Valor linha = qtd_produto * vlr_unitario (se n√£o cancelado)
-- -----------------------------------------------------
-- Exemplo de registro:
-- | id  | id_pedido | id_produto | flg_cancelado | qtd_produto | vlr_unitario |
-- |-----|-----------|------------|---------------|-------------|--------------|
-- | 500 | 100       | 10         | N             | 2           | 149.95       |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.meta
-- -----------------------------------------------------
-- Descri√ß√£o: Metas de vendas por marca e per√≠odo
-- Granularidade: Uma linha por marca/m√™s/ano
-- Relacionamentos:
--   - meta ‚Üí marca (N:1)
-- -----------------------------------------------------
-- Campos:
--   ano             : Ano da meta (parte da PK composta)
--   mes             : M√™s da meta (1-12) (parte da PK composta)
--   id_marca        : FK para marca (parte da PK composta)
--   valor           : Valor da meta de vendas para o per√≠odo
--   criado_em       : Timestamp de cria√ß√£o do registro
--   atualizado_em   : Timestamp da √∫ltima atualiza√ß√£o
-- -----------------------------------------------------
-- Chave Prim√°ria: (ano, mes, id_marca)
--   Garante uma √∫nica meta por marca/per√≠odo
-- -----------------------------------------------------
-- Exemplo de registro:
-- | ano  | mes | id_marca | valor      |
-- |------|-----|----------|------------|
-- | 2024 | 1   | 1        | 100000.00  |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.log_ingestao
-- -----------------------------------------------------
-- Descri√ß√£o: Log de auditoria de cargas de dados
-- Prop√≥sito: Rastreabilidade e governan√ßa
-- Granularidade: Uma linha por execu√ß√£o de carga
-- -----------------------------------------------------
-- Campos:
--   id                : Identificador √∫nico do log (PK)
--   tabela            : Nome da tabela carregada
--   data_ingestao     : Timestamp da carga
--   usuario           : Usu√°rio que executou a carga
--   qtd_registros     : Quantidade de registros inseridos
-- -----------------------------------------------------
-- Exemplo de registro:
-- | id | tabela         | data_ingestao       | usuario  | qtd_registros |
-- |----|----------------|---------------------|----------|---------------|
-- | 1  | trusted.pedido | 2024-01-01 10:00:00 | postgres | 1500          |
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: trusted.dicionario_de_dados
-- -----------------------------------------------------
-- Descri√ß√£o: Dicion√°rio de dados do projeto
-- Prop√≥sito: Documenta√ß√£o inline das colunas
-- -----------------------------------------------------
-- Campos:
--   tabela          : Nome da tabela
--   coluna          : Nome da coluna
--   descricao       : Descri√ß√£o do campo
--   exemplo         : Exemplo de valor
-- -----------------------------------------------------

-- =====================================================
-- SCHEMA: refined
-- =====================================================

-- -----------------------------------------------------
-- Tabela: refined.mais_vendidos_mensal_estado
-- -----------------------------------------------------
-- Descri√ß√£o: Ranking de produtos mais vendidos por estado/m√™s
-- Granularidade: Uma linha por produto/estado/m√™s
-- Atualiza√ß√£o: Recriada a cada execu√ß√£o do pipeline
-- Consumo: Dashboards de Top Produtos, An√°lise Regional
-- -----------------------------------------------------
-- Campos:
--   mes_ano         : Primeiro dia do m√™s de refer√™ncia
--   sgl_uf_entrega  : Estado (UF) de entrega
--   id_produto      : ID do produto
--   nome_produto    : Nome do produto
--   total_qtd       : Quantidade total vendida no per√≠odo
--   posicao         : Ranking dentro do estado/m√™s (1 = mais vendido)
-- -----------------------------------------------------
-- Chave Prim√°ria: (mes_ano, sgl_uf_entrega, id_produto)
-- -----------------------------------------------------
-- Regras de C√°lculo:
--   - Considera apenas itens N√ÉO cancelados (flg_cancelado = 'N')
--   - Ranking usando RANK() (pode haver empates)
--   - Ordena√ß√£o por quantidade (DESC)
-- -----------------------------------------------------
-- Casos de Uso:
--   1. Identificar produtos mais populares por regi√£o
--   2. Comparar performance de produtos entre estados
--   3. An√°lise de sazonalidade por produto/regi√£o
-- -----------------------------------------------------
-- Exemplo de query:
--   -- Top 5 produtos mais vendidos em SP em Janeiro/2024
--   SELECT * FROM refined.mais_vendidos_mensal_estado
--   WHERE mes_ano = '2024-01-01' 
--     AND sgl_uf_entrega = 'SP' 
--     AND posicao <= 5
--   ORDER BY posicao;
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: refined.performance_mensal_marca
-- -----------------------------------------------------
-- Descri√ß√£o: Performance de vendas vs meta por marca
-- Granularidade: Uma linha por marca/m√™s/ano
-- Atualiza√ß√£o: Recriada a cada execu√ß√£o do pipeline
-- Consumo: Dashboards Gerenciais, OKRs, An√°lise de Metas
-- -----------------------------------------------------
-- Campos:
--   ano                       : Ano de refer√™ncia
--   mes                       : M√™s de refer√™ncia (1-12)
--   id                        : ID da marca
--   nome_marca                : Nome da marca
--   vlr_total_vendido         : Valor total vendido pela marca no per√≠odo
--   vlr_meta                  : Meta de vendas da marca (se definida)
--   perc_atingimento_meta     : Percentual de atingimento (vendido/meta * 100)
-- -----------------------------------------------------
-- Regras de C√°lculo:
--   - vlr_total_vendido = soma de todos os pedidos da marca
--   - vlr_meta vem de trusted.meta (pode ser NULL se n√£o houver meta)
--   - perc_atingimento_meta = (vlr_total_vendido / vlr_meta) * 100
-- -----------------------------------------------------
-- Casos de Uso:
--   1. Acompanhamento de metas mensais
--   2. Identificar marcas com melhor/pior performance
--   3. An√°lise de tend√™ncias de vendas por marca
-- -----------------------------------------------------
-- Exemplo de query:
--   -- Marcas que bateram a meta em Janeiro/2024
--   SELECT nome_marca, vlr_total_vendido, vlr_meta, perc_atingimento_meta
--   FROM refined.performance_mensal_marca
--   WHERE ano = 2024 AND mes = 1 AND perc_atingimento_meta >= 100
--   ORDER BY perc_atingimento_meta DESC;
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: refined.kpis_vendas
-- -----------------------------------------------------
-- Descri√ß√£o: KPIs consolidados de vendas mensais
-- Granularidade: Uma linha por m√™s
-- Atualiza√ß√£o: Recriada a cada execu√ß√£o do pipeline
-- Consumo: Dashboards Executivos, An√°lise de Tend√™ncias
-- -----------------------------------------------------
-- Campos:
--   mes_ano                   : Primeiro dia do m√™s de refer√™ncia
--   qtd_pedidos               : Total de pedidos no per√≠odo
--   receita_bruta             : Receita total (soma de vlr_total)
--   ticket_medio              : Ticket m√©dio (receita / qtd_pedidos)
--   qtd_cancelamentos         : Quantidade de pedidos cancelados
--   pct_cancelamento          : Taxa de cancelamento (%)
--   qtd_produtos_distintos    : Quantidade de produtos diferentes vendidos
--   qtd_itens_vendidos        : Quantidade total de itens vendidos
-- -----------------------------------------------------
-- Casos de Uso:
--   1. An√°lise de sa√∫de do neg√≥cio
--   2. Identifica√ß√£o de tend√™ncias (crescimento, queda)
--   3. Monitoramento de cancelamentos
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: refined.analise_cancelamentos
-- -----------------------------------------------------
-- Descri√ß√£o: An√°lise detalhada de cancelamentos
-- Granularidade: Uma linha por marca/estado/m√™s
-- Prop√≥sito: Identificar padr√µes de cancelamento
-- -----------------------------------------------------
-- Campos:
--   mes_ano                     : M√™s de refer√™ncia
--   sgl_uf_entrega              : Estado
--   marca                       : Nome da marca
--   qtd_pedidos_cancelados      : Total de pedidos cancelados
--   vlr_total_cancelado         : Valor total de pedidos cancelados
--   qtd_itens_cancelados        : Total de itens cancelados
--   ticket_medio_cancelado      : Ticket m√©dio dos cancelamentos
-- -----------------------------------------------------
-- Casos de Uso:
--   1. Identificar problemas por regi√£o
--   2. Detectar problemas com marcas espec√≠ficas
--   3. An√°lise de perda de receita
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: refined.vendas_categoria_variacao
-- -----------------------------------------------------
-- Descri√ß√£o: An√°lise de crescimento/queda por categoria
-- Granularidade: Uma linha por categoria/m√™s
-- Prop√≥sito: Identificar tend√™ncias por categoria
-- -----------------------------------------------------
-- Campos:
--   mes_ano               : M√™s de refer√™ncia
--   categoria             : Nome da categoria
--   total_qtd             : Quantidade vendida
--   total_valor           : Valor total vendido
--   pct_variacao_qtd      : Varia√ß√£o % de quantidade vs m√™s anterior
--   pct_variacao_valor    : Varia√ß√£o % de valor vs m√™s anterior
-- -----------------------------------------------------
-- Casos de Uso:
--   1. Identificar categorias em crescimento
--   2. Detectar sazonalidade
--   3. Planejar mix de produtos
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Tabela: refined.analise_regional
-- -----------------------------------------------------
-- Descri√ß√£o: Performance de vendas por regi√£o (UF)
-- Granularidade: Uma linha por estado/m√™s
-- Prop√≥sito: An√°lise geogr√°fica de vendas
-- -----------------------------------------------------
-- Campos:
--   mes_ano                   : M√™s de refer√™ncia
--   sgl_uf_entrega            : Estado
--   qtd_pedidos               : Total de pedidos
--   receita_total             : Receita total do estado
--   ticket_medio              : Ticket m√©dio
--   qtd_itens                 : Total de itens vendidos
--   qtd_produtos_distintos    : Diversidade de produtos
--   qtd_marcas_distintas      : Diversidade de marcas
-- -----------------------------------------------------
-- Casos de Uso:
--   1. Identificar regi√µes mais lucrativas
--   2. Planejar expans√£o/log√≠stica
--   3. An√°lise de penetra√ß√£o de marcas por regi√£o
-- -----------------------------------------------------

-- =====================================================
-- üìà EXEMPLO DE AN√ÅLISES
-- =====================================================

-- An√°lise 1: Top 10 produtos mais vendidos em todo Brasil em 2024
-- SELECT 
--     p.nome_produto,
--     SUM(mv.total_qtd) as total_vendido,
--     COUNT(DISTINCT mv.sgl_uf_entrega) as qtd_estados
-- FROM refined.mais_vendidos_mensal_estado mv
-- WHERE EXTRACT(YEAR FROM mv.mes_ano) = 2024
-- GROUP BY p.nome_produto
-- ORDER BY total_vendido DESC
-- LIMIT 10;

-- An√°lise 2: Evolu√ß√£o de vendas m√™s a m√™s (trend)
-- SELECT 
--     mes_ano,
--     receita_bruta,
--     ticket_medio,
--     pct_cancelamento
-- FROM refined.kpis_vendas
-- ORDER BY mes_ano;

-- An√°lise 3: Marcas que N√ÉO atingiram meta
-- SELECT 
--     nome_marca,
--     ano,
--     mes,
--     vlr_total_vendido,
--     vlr_meta,
--     perc_atingimento_meta
-- FROM refined.performance_mensal_marca
-- WHERE perc_atingimento_meta < 100
-- ORDER BY perc_atingimento_meta ASC;

-- =====================================================
-- üîí GOVERNAN√áA E SEGURAN√áA
-- =====================================================

/*
1. LGPD Compliance:
   - Dados PII separados (cliente_pii)
   - Pseudonimiza√ß√£o via hash (cliente_pseudo)
   - Auditoria via log_ingestao

2. Qualidade de Dados:
   - Constraints e valida√ß√µes
   - Scripts de valida√ß√£o autom√°tica
   - Integridade referencial

3. Performance:
   - √çndices estrat√©gicos
   - Tabelas refined desnormalizadas
   - Triggers para atualiza√ß√£o autom√°tica

4. Rastreabilidade:
   - Campos criado_em / atualizado_em
   - Log de ingest√µes
   - Versionamento de modelo
*/

-- =====================================================
-- FIM DA DOCUMENTA√á√ÉO
-- =====================================================

